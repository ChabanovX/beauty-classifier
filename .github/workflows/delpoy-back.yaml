name: Deploy to VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ml-vm-runner
    
    steps:
    - name: Pull code
      run: |
          cd ~/beauty-classifier
          git pull
    - name: Update project dependencies
      run: . .venv/bin/activate && make setup-prod
    - name: Stop and restart containers
      run: docker compose down && docker compose pull && docker compose up -d
    - name: Clean up unused images
      run: docker image prune -f
